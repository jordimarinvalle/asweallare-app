<div class="page no-navbar no-toolbar" data-name="game">
  <div class="page-content" style="padding: 0;">
    
    <!-- Rotate Device Screen -->
    <div id="rotate-screen" class="rotate-device-screen" style="display: none;">
      <div class="rotate-icon">
        <i class="f7-icons" style="font-size: 64px; color: #8E8E93;">device_phone_landscape</i>
      </div>
      <h2 style="margin-top: 24px; font-size: 20px; font-weight: 600;">Rotate Your Device</h2>
      <p style="color: #8E8E93; margin-top: 8px;">Please rotate to landscape mode to play</p>
    </div>
    
    <!-- Game Content -->
    <div id="game-content" class="game-content game-screen" style="display: flex;">
      
      <!-- Exit Button -->
      <button id="exit-btn" class="button" style="position: absolute; top: 20px; left: 20px; padding: 8px 16px;">
        <i class="f7-icons" style="font-size: 20px;">xmark</i>
      </button>
      
      <!-- Timer Display -->
      <div id="timer-display" class="timer-display idle">
        Tap on the cards to flip them and start your turn
      </div>
      
      <!-- Reset Button -->
      <button id="reset-btn" class="button" style="position: absolute; top: 20px; right: 20px; padding: 8px;">
        <i class="f7-icons" style="font-size: 20px;">arrow_counterclockwise</i>
      </button>
      
      <!-- Card Piles -->
      <div class="game-cards-container">
        
        <!-- Black Pile -->
        <div class="pile-container" style="text-align: center;">
          <div class="card-stack-wrapper">
            <!-- Stacked cards behind (for visual effect) -->
            <div class="stacked-card stacked-1" id="black-stack-1"></div>
            <div class="stacked-card stacked-2" id="black-stack-2"></div>
            <div class="stacked-card stacked-3" id="black-stack-3"></div>
            <!-- Main card -->
            <div id="black-pile" class="card-pile black">
              <div class="card-inner">
                <div class="card-back" style="background: #000; border: 2px solid #666;">
                  <img src="/assets/black-card-back.png" alt="Black card" style="width:100%;height:100%;object-fit:cover;border-radius:10px;" onerror="this.style.display='none'" />
                  <div style="position:absolute;inset:0;display:flex;align-items:center;justify-content:center;">
                    <span style="background:#D12128;color:white;padding:8px 16px;border-radius:20px;font-size:14px;font-weight:500;">
                      <i class="f7-icons" style="font-size:14px;">arrow_2_circlepath</i> Tap
                    </span>
                  </div>
                </div>
                <div id="black-front" class="card-front" style="background: #000; border: 2px solid #666;"></div>
              </div>
            </div>
          </div>
          <p id="black-count" class="pile-count" style="margin-top: 12px; color: #8E8E93; font-size: 14px;"></p>
        </div>
        
        <!-- White Pile -->
        <div class="pile-container" style="text-align: center;">
          <div class="card-stack-wrapper">
            <!-- Stacked cards behind (for visual effect) -->
            <div class="stacked-card stacked-1" id="white-stack-1"></div>
            <div class="stacked-card stacked-2" id="white-stack-2"></div>
            <div class="stacked-card stacked-3" id="white-stack-3"></div>
            <!-- Main card -->
            <div id="white-pile" class="card-pile white">
              <div class="card-inner">
                <div class="card-back" style="background: #fff; border: 2px solid #ddd;">
                  <img src="/assets/white-card-back.png" alt="White card" style="width:100%;height:100%;object-fit:cover;border-radius:10px;" onerror="this.style.display='none'" />
                  <div style="position:absolute;inset:0;display:flex;align-items:center;justify-content:center;">
                    <span style="background:#D12128;color:white;padding:8px 16px;border-radius:20px;font-size:14px;font-weight:500;">
                      <i class="f7-icons" style="font-size:14px;">arrow_2_circlepath</i> Tap
                    </span>
                  </div>
                </div>
                <div id="white-front" class="card-front" style="background: #fff; border: 2px solid #ddd;"></div>
              </div>
            </div>
          </div>
          <p id="white-count" class="pile-count" style="margin-top: 12px; color: #8E8E93; font-size: 14px;"></p>
        </div>
        
      </div>
      
    </div>
  </div>
</div>

<script>
(function() {
  const state = window.appState;
  const { drawCard, flipCard, resetRound, endGame, startSharing, finishSharing } = window.appFunctions;
  
  // Generate random rotation between -5 and 5 degrees
  function getRandomRotation() {
    return (Math.random() - 0.5) * 10; // -5 to +5 degrees
  }
  
  // Generate random offset between -3 and 3 pixels
  function getRandomOffset() {
    return (Math.random() - 0.5) * 6; // -3 to +3 pixels
  }
  
  // Apply random rotations to stacked cards for natural look
  function applyStackRotations() {
    console.log('[Game] Applying stack rotations');
    
    // Black pile stacked cards
    for (let i = 1; i <= 3; i++) {
      const el = document.getElementById(`black-stack-${i}`);
      if (el) {
        const rotation = getRandomRotation();
        const offsetX = getRandomOffset();
        const offsetY = getRandomOffset();
        el.style.transform = `rotate(${rotation}deg) translate(${offsetX}px, ${offsetY}px)`;
        console.log(`[Game] black-stack-${i}: rotate(${rotation.toFixed(1)}deg)`);
      }
    }
    
    // White pile stacked cards  
    for (let i = 1; i <= 3; i++) {
      const el = document.getElementById(`white-stack-${i}`);
      if (el) {
        const rotation = getRandomRotation();
        const offsetX = getRandomOffset();
        const offsetY = getRandomOffset();
        el.style.transform = `rotate(${rotation}deg) translate(${offsetX}px, ${offsetY}px)`;
        console.log(`[Game] white-stack-${i}: rotate(${rotation.toFixed(1)}deg)`);
      }
    }
  }
  
  // Helper to get correct image URL
  function getImageUrl(path) {
    if (!path) return '';
    // If it already starts with http/https, return as-is (no leading slash)
    if (path.startsWith('http://') || path.startsWith('https://')) {
      return path;
    }
    // Otherwise add leading slash if needed
    return path.startsWith('/') ? path : '/' + path;
  }
  
  function checkOrientation() {
    const isLandscape = window.innerWidth > window.innerHeight;
    const rotateScreen = document.getElementById('rotate-screen');
    const gameContent = document.getElementById('game-content');
    
    if (rotateScreen && gameContent) {
      rotateScreen.style.display = isLandscape ? 'none' : 'flex';
      gameContent.style.display = isLandscape ? 'flex' : 'none';
    }
  }
  
  function updateTimerDisplay() {
    const timerEl = document.getElementById('timer-display');
    if (!timerEl) return;
    
    const { timerState, timerSeconds } = state;
    
    timerEl.className = `timer-display ${timerState}`;
    
    switch (timerState) {
      case 'idle':
        timerEl.textContent = 'Tap on the cards to flip them and start your turn';
        break;
      case 'countdown':
        timerEl.textContent = `Ready? Tap to begin sharing (${timerSeconds}s)`;
        break;
      case 'waiting':
        timerEl.textContent = 'Ready when you are — tap to start sharing';
        break;
      case 'countup':
        const mins = Math.floor(timerSeconds / 60);
        let msg = "Tap when you're done sharing";
        if (mins >= 3) msg = "Tap when done. 3 minutes — wrapping up?";
        else if (mins >= 2) msg = "Tap when done. 2 minutes — you're in the flow.";
        else if (mins >= 1) msg = "Tap when done. 1 minute — keep sharing.";
        timerEl.textContent = msg;
        break;
      case 'finished':
        const finMins = Math.floor(timerSeconds / 60);
        const finSecs = timerSeconds % 60;
        let timeStr = finSecs + 's';
        if (finMins > 0) timeStr = `${finMins}m ${finSecs}s`;
        timerEl.textContent = `Done (${timeStr}) — tap to reset for next turn`;
        break;
    }
  }
  
  function updateStackVisibility(pile, count) {
    // Show/hide stacked cards based on deck size
    for (let i = 1; i <= 3; i++) {
      const el = document.getElementById(`${pile}-stack-${i}`);
      if (el) {
        // Show stack 1 if > 3 cards, stack 2 if > 2, stack 3 if > 1
        const threshold = 4 - i;
        el.style.opacity = count > threshold ? '1' : '0';
      }
    }
  }
  
  function updateCards() {
    const blackPile = document.getElementById('black-pile');
    const whitePile = document.getElementById('white-pile');
    const blackFront = document.getElementById('black-front');
    const whiteFront = document.getElementById('white-front');
    const blackCount = document.getElementById('black-count');
    const whiteCount = document.getElementById('white-count');
    
    // Get deck counts
    const blackDeckCount = state.blackDeck ? state.blackDeck.length : 0;
    const whiteDeckCount = state.whiteDeck ? state.whiteDeck.length : 0;
    
    console.log('[Game] updateCards - blackDeck:', blackDeckCount, 'whiteDeck:', whiteDeckCount);
    
    // Update black card
    if (blackPile && blackFront) {
      if (state.currentBlack) {
        blackPile.classList.toggle('flipped', state.blackFlipped);
        const imgSrc = getImageUrl(state.currentBlack.image_path);
        blackFront.innerHTML = imgSrc 
          ? `<img src="${imgSrc}" alt="Card" style="width:100%;height:100%;object-fit:cover;border-radius:10px;" onerror="this.style.display='none'" />`
          : '';
      } else {
        blackPile.classList.remove('flipped');
      }
    }
    
    // Update white card
    if (whitePile && whiteFront) {
      if (state.currentWhite) {
        whitePile.classList.toggle('flipped', state.whiteFlipped);
        const imgSrc = getImageUrl(state.currentWhite.image_path);
        whiteFront.innerHTML = imgSrc
          ? `<img src="${imgSrc}" alt="Card" style="width:100%;height:100%;object-fit:cover;border-radius:10px;" onerror="this.style.display='none'" />`
          : '';
      } else {
        whitePile.classList.remove('flipped');
      }
    }
    
    // Update card counts
    if (blackCount) {
      blackCount.textContent = `${blackDeckCount} cards left`;
    }
    if (whiteCount) {
      whiteCount.textContent = `${whiteDeckCount} cards left`;
    }
    
    // Update stack visibility based on deck size
    updateStackVisibility('black', blackDeckCount);
    updateStackVisibility('white', whiteDeckCount);
  }
  
  // Event listeners
  window.addEventListener('resize', checkOrientation);
  window.addEventListener('orientationchange', checkOrientation);
  document.addEventListener('timer-update', updateTimerDisplay);
  
  // Card pile clicks
  document.getElementById('black-pile')?.addEventListener('click', () => {
    if (!state.currentBlack && state.blackDeck && state.blackDeck.length > 0) {
      drawCard('black');
      applyStackRotations(); // Re-randomize on each draw
    } else if (state.currentBlack) {
      flipCard('black');
    }
    updateCards();
  });
  
  document.getElementById('white-pile')?.addEventListener('click', () => {
    if (!state.currentWhite && state.whiteDeck && state.whiteDeck.length > 0) {
      drawCard('white');
      applyStackRotations(); // Re-randomize on each draw
    } else if (state.currentWhite) {
      flipCard('white');
    }
    updateCards();
  });
  
  // Timer click
  document.getElementById('timer-display')?.addEventListener('click', () => {
    const { timerState } = state;
    if (timerState === 'countdown' || timerState === 'waiting') {
      startSharing();
    } else if (timerState === 'countup') {
      finishSharing();
    } else if (timerState === 'finished') {
      resetRound();
      updateCards();
    }
    updateTimerDisplay();
  });
  
  // Reset button
  document.getElementById('reset-btn')?.addEventListener('click', () => {
    resetRound();
    updateCards();
    updateTimerDisplay();
  });
  
  // Exit button
  document.getElementById('exit-btn')?.addEventListener('click', () => {
    endGame();
    window.f7App.views.main.router.navigate('/experience/');
  });
  
  // Initial setup
  console.log('[Game] Page initialized, state:', {
    blackDeck: state.blackDeck?.length,
    whiteDeck: state.whiteDeck?.length
  });
  
  checkOrientation();
  applyStackRotations();
  updateCards();
  updateTimerDisplay();
})();
</script>
