<div class="page" data-name="experience">
  <div class="navbar">
    <div class="navbar-bg"></div>
    <div class="navbar-inner">
      <div class="title">Select Deck</div>
    </div>
  </div>
  
  <div class="toolbar tabbar tabbar-labels toolbar-bottom">
    <div class="toolbar-inner">
      <a href="/" class="tab-link">
        <i class="f7-icons">house_fill</i>
        <span class="tabbar-label">Home</span>
      </a>
      <a href="/experience/" class="tab-link tab-link-active">
        <i class="f7-icons">gamecontroller_fill</i>
        <span class="tabbar-label">Experience</span>
      </a>
      <a href="/store/" class="tab-link">
        <i class="f7-icons">bag_fill</i>
        <span class="tabbar-label">Store</span>
      </a>
      <a href="/profile/" class="tab-link">
        <i class="f7-icons">person_fill</i>
        <span class="tabbar-label">Profile</span>
      </a>
    </div>
  </div>
  
  <div class="page-content">
    <div class="block-title">Choose Your Decks</div>
    <div class="block">
      <p style="color: #8E8E93;">Select one or more decks to play with. Tap to select, then press Play.</p>
    </div>
    
    <div id="deck-scroll" class="deck-scroll">
      <!-- Decks will be rendered here -->
    </div>
    
    <div class="block" style="margin-top: 24px;">
      <button id="play-btn" class="button button-large button-fill disabled" style="max-width: 280px; margin: 0 auto;">
        <i class="f7-icons">play_fill</i>
        <span style="margin-left: 8px;">Play</span>
      </button>
    </div>
    
    <div class="block" style="padding-bottom: 100px;"></div>
  </div>
</div>

<script>
// Use a self-executing function to initialize the page
(function initExperiencePage() {
  console.log('[Experience] Page script starting');
  
  // Get state and functions from global
  var state = window.appState;
  var startGame = window.appFunctions ? window.appFunctions.startGame : null;
  var selectedBoxIds = [];
  
  console.log('[Experience] State available:', !!state);
  console.log('[Experience] Boxes in state:', state ? state.boxes.length : 0);
  
  function renderDecks() {
    console.log('[Experience] renderDecks called');
    var container = document.getElementById('deck-scroll');
    if (!container) {
      console.log('[Experience] Container not found');
      return;
    }
    
    var boxes = state && state.boxes ? state.boxes : [];
    console.log('[Experience] Rendering', boxes.length, 'boxes');
    
    if (boxes.length === 0) {
      container.innerHTML = '<div style="padding: 40px; text-align: center; color: #8E8E93;">No decks available. Loading...</div>';
      return;
    }
    
    var html = '';
    boxes.forEach(function(box) {
      var isLocked = !box.is_sample && !box.hasAccess;
      var heroImage = box.path ? '/collections/' + box.path + '/hero.jpg' : '/assets/logo-asweallare.png';
      
      html += '<div class="deck-tile" data-box-id="' + box.id + '" data-locked="' + isLocked + '" data-sample="' + box.is_sample + '" style="border: 2px solid transparent;">';
      html += '  <img src="' + heroImage + '" alt="' + box.name + '" onerror="this.src=\'/assets/logo-asweallare.png\'" style="opacity: ' + (isLocked ? '0.6' : '1') + ';" />';
      
      if (box.is_sample) {
        html += '  <span class="sample-badge">SAMPLE</span>';
      }
      
      if (isLocked) {
        html += '  <div class="lock-overlay"><i class="f7-icons" style="color: white; font-size: 32px;">lock_fill</i></div>';
      }
      
      html += '  <div style="position: absolute; bottom: 0; left: 0; right: 0; padding: 12px; background: linear-gradient(transparent, rgba(0,0,0,0.7));">';
      html += '    <p style="color: white; font-weight: 600; font-size: 14px; margin: 0;">' + box.name + '</p>';
      if (box.tagline) {
        html += '    <p style="color: rgba(255,255,255,0.7); font-size: 11px; margin: 4px 0 0 0;">' + box.tagline + '</p>';
      }
      html += '  </div>';
      html += '</div>';
    });
    
    container.innerHTML = html;
    console.log('[Experience] Rendered HTML, adding click handlers');
    
    // Add click handlers
    var tiles = container.querySelectorAll('.deck-tile');
    tiles.forEach(function(tile) {
      tile.addEventListener('click', function() {
        var boxId = tile.getAttribute('data-box-id');
        var isLocked = tile.getAttribute('data-locked') === 'true';
        
        console.log('[Experience] Tile clicked:', boxId, 'locked:', isLocked);
        
        if (isLocked) {
          if (window.f7App) {
            window.f7App.dialog.alert('This deck is locked. Purchase it in the Store to unlock.', 'Locked');
          }
          return;
        }
        
        var idx = selectedBoxIds.indexOf(boxId);
        if (idx > -1) {
          selectedBoxIds.splice(idx, 1);
          tile.style.borderColor = 'transparent';
          tile.style.transform = 'scale(1)';
        } else {
          selectedBoxIds.push(boxId);
          tile.style.borderColor = '#007AFF';
          tile.style.transform = 'scale(0.95)';
        }
        
        var playBtn = document.getElementById('play-btn');
        if (playBtn) {
          if (selectedBoxIds.length > 0) {
            playBtn.classList.remove('disabled');
          } else {
            playBtn.classList.add('disabled');
          }
        }
        
        console.log('[Experience] Selected boxes:', selectedBoxIds);
      });
    });
  }
  
  // Setup play button
  var playBtn = document.getElementById('play-btn');
  if (playBtn) {
    playBtn.addEventListener('click', function() {
      if (selectedBoxIds.length > 0 && startGame) {
        console.log('[Experience] Starting game with:', selectedBoxIds);
        startGame(selectedBoxIds);
        if (window.f7App && window.f7App.views && window.f7App.views.main) {
          window.f7App.views.main.router.navigate('/game/');
        }
      }
    });
  }
  
  // Render immediately
  renderDecks();
  
  // Also set up a watcher in case data loads later
  var checkInterval = setInterval(function() {
    if (state && state.boxes && state.boxes.length > 0) {
      var container = document.getElementById('deck-scroll');
      if (container && container.querySelectorAll('.deck-tile').length === 0) {
        console.log('[Experience] Data arrived, re-rendering');
        renderDecks();
      }
      // Stop checking after we have data and rendered
      if (container && container.querySelectorAll('.deck-tile').length > 0) {
        clearInterval(checkInterval);
      }
    }
  }, 500);
  
  // Clear interval after 10 seconds max
  setTimeout(function() {
    clearInterval(checkInterval);
  }, 10000);
})();
</script>
